# 8253 定时计数

## 结构

定时功能实现

-   软件延时
-   不可编程的硬件定时
-   可编程的硬件定时



8253/8254

-   3个独立16位计数器通道
-   每个计数器有6种工作方式
-   按二进制或BCD计数

![image-20210702233303562](8253.assets/image-20210702233303562.png)

-   预置寄存器：计数初值
-   减法计数器：不断递减
-   输出锁存器：写入锁存命令时 锁定当前计数

计数结束时**OUT**产生输出信号

| CS*   A1   A0 | I/O地址 | RD*       | WR*        |
| :-----------: | ------- | --------- | ---------- |
|   0   0   0   | 40H     | Read Cnt0 | Write Cnt0 |
|   0   0   1   | 41H     | Read Cnt1 | Write Cnt1 |
|   0   1   0   | 42H     | Read Cnt2 | Write Cnt2 |
|   0   1   1   | 43H     | NOP       | 写控制字   |

## 方式

每种工作方式的过程类似：

1.  设定工作方式
2.  设定计数初值
3.  （硬件启动）
4.  计数初值进入减1计数器
5.  每输入一个时钟计数器减1的计数过程
6.  计数过程结束



方式

0.  计数结束中断
1.  可编程单稳脉冲
2.  频率发生器（分频器）
3.  方波发生器
4.  软件触发选通信号
5.  硬件触发选通信号

![image-20210702234733236](8253.assets/image-20210702234733236.png "输出波形")

### 计数开始

-   处理器写入8253计数初值只是写入预置寄存器 下一个**CLK**输入脉冲才将初值送到计数器
-   第二个**CLK**信号 计数器才真正开始计数

## 8253编程

必须初始化编程

写入控制字

-   写入计数初值
-   读取计数值
-   8254新增读回命令

### 写入方式控制字

>   写入控制字I/O地址 **$A_1A_0=11$**

<table>
<tr>
    <th>D7</th>
    <th>D6</th>
    <th>D5</th>
    <th>D4</th>
    <th>D3</th>
    <th>D2</th>
    <th>D1</th>
    <th>D0</th>
</tr>
<tr>
    <td colspan="2">计数器</td>
    <td colspan="2">读写格式</td>
    <td colspan="3">工作方式</td>
    <td>数制</td>
</tr>
</table>

计数器：

| 00      | 01      | 10      | 11   |
| ------- | ------- | ------- | ---- |
| 计数器0 | 计数器1 | 计数器2 | 非法 |

读写格式：

| 00         | 01         | 10         | 11               |
| ---------- | ---------- | ---------- | ---------------- |
| 计数器锁存 | 低字节only | 高字节only | 先低字节后高字节 |

工作方式：000-101 方式0-5

数制

0.  binary
1.  BCD

```asm
mov al,36h;00110110B
;计数器0为方式3，采用二进制计数，
;先低后高写入计数值
out 43h,al	;写入方式控制字
mov al,0	;计数值为0
out 40h,al	;写入低字节计数值
out 40h,al	;写入高字节计数值
```



```asm
mov al,54h
;计数器1为方式2，采用二进制计数，只写低8位计数值
out 43h,al	;写入方式控制字
mov al,18	;计数初值为18
out 41h,al	;写入计数值
```

